<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>VulnHound - Result</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
  </head>
  <body class="p-4">
    <div class="container">
      <a href="/" class="btn btn-link">&larr; Back</a>
      <h1>Scan: {{ result.domain }}</h1>
      <p>Scan ID: {{ result.scan_id }} — Status: <strong>{{ result.status }}</strong></p>

      <h3>Subdomains ({{ result.subdomains | length }})</h3>
      <ul>
        {% for s in result.subdomains %}
          <li>{{ s }}</li>
        {% endfor %}
      </ul>

      <h3>Fingerprints</h3>
      <table class="table table-sm">
        <thead>
          <tr>
            <th>Host</th><th>Up</th><th>Status</th><th>Server</th><th>Title</th><th>Tech</th>
          </tr>
        </thead>
        <tbody>
          {% for f in result.fingerprints %}
            <tr>
              <td>{% if f.url %}<a href="{{ f.url }}" target="_blank">{{ f.host }}</a>{% else %}{{ f.host }}{% endif %}</td>
              <td>{{ f.up }}</td>
              <td>{{ f.status_code }}</td>
              <td>{{ f.server_header }}</td>
              <td>{{ f.title }}</td>
              <td>{{ f.technologies | join(", ") }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

      <h3>Mapped CVEs</h3>
      {% if result.cves and result.cves|length>0 %}
        {% for tech, cves in result.cves.items() %}
          <h5 class="mt-3">{{ tech }}</h5>
          <ul>
            {% for c in cves %}
              <li>
                <strong>{{ c.id }}</strong> — {{ c.description[:180] }}
                {% if c.severity %}(CVSS: {{ c.severity }}){% endif %}
              </li>
            {% else %}
              <li>No recent CVEs found.</li>
            {% endfor %}
          </ul>
        {% endfor %}

        <div class="mt-4">
          <h5>Severity distribution</h5>
          <canvas id="sevChart"></canvas>
        </div>

        <script>
          // Use a unique variable name to avoid redeclaration warnings
          const severityBuckets = JSON.parse('{{ buckets | tojson | safe }}');         
          if (severityBuckets && Object.keys(severityBuckets).length >0) {
          new Chart(document.getElementById('sevChart'), {
              type: 'bar',
              data: {
              labels: Object.keys(severityBuckets),
              datasets: [{
                  label: 'CVEs',
                  data: Object.values(severityBuckets),
                  backgroundColor: '#007bff'
                }]
              },
            options: {
            responsive: true,
            plugins: {
            legend: { display: false },
            title: { display: false }
              }
            }
          });
        }
      </script>
      {% else %}
        <p>No CVEs mapped.</p>
      {% endif %}
    </div>
  </body>
</html>
